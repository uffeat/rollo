<style global>
  /* Controls cards per row */
  #app[state-path="/blog"] [page] {
    --basis: 100%;
  }
  #app[state-path="/blog"][state-md] [page] {
    --gap: 0.5rem;
    --items: 2;
    --basis: calc(calc(100% / var(--items)) - var(--gap));
  }
  #app[state-path="/blog"][state-xl] [page] {
    --items: 3;
  }

  /* Images in post */
  #app[state-path="/blog"] [post] p:has(>img) {
    display: flex;
    justify-content: center;

  }
</style>

<script type="module">
  const { component } = await use("@/component");
  const { layout } = await use("@/layout/");
  const { reactive, ref } = await use("@/state");
  const { marked } = await use("@/marked");
  const { YAML } = await use("@/yaml");
  const { Sheet, css } = await use("@/sheet");
  const { router, Nav, NavLink } = await use("@/router/");
  const { toTop } = await use("@/tools/scroll");

  const START = "/content".length - 2;
  const END = ".md".length;
  const LINK = "a.nav-link"

  const items = component.div(
    "w-full flex justify-between flex-wrap gap-y-3 gap-x-(--gap)",
    {}
  );
  items.attribute.items = true;

  const page = component.main(
    "container mt-3 mb-3",
    items
  );
  page.attribute.page = true;

  const building = new Map();

  const Item = ({ html, meta, path, resolve }) => {
    const card = component.div(
      "card h-full basis-(--basis)",
      {
        parent: items,
      },
      component.img("card-img-top", { src: `${use.meta.base}${meta.image}` }),
      component.div(
        "card-body nav flex flex-col",
        {},
        component.a(
          "nav-link cursor-pointer",
          component.h1("card-title", { text: meta.title })
        ),
        component.p("card-text", { text: meta.abstract })
      ),
      component.div("card-footer min-h-8")
    );
    card.attribute.card = path;
    const post = component.div("hidden", { innerHTML: html });
    post.attribute.post = path;

    card.detail.post = post;

    card.on.click = (event) => {
      if (
        event.target.matches(LINK) ||
        event.target.closest(LINK)
      ) {
        //console.log("Clicked!"); ////
        //console.log('path:', path)////
        router("/blog" + path);
      }
    };
    resolve(card);
    building.delete(path);
  };

  const paths = (await use("/content/meta/paths.json")).filter((p) =>
    p.startsWith("/blog/")
  );

  /* Build items without blocking */
  for (const path of paths) {
    const { promise, resolve } = Promise.withResolvers();
    const _path = "/" + path.slice(START, -END).toLowerCase();
    building.set(_path, promise);
    use(`/content${path}`).then((text) => {
      const [yaml, md] = text.split("---").slice(1);
      const meta = YAML.parse(yaml);
      const html = marked.parse(md);
      Item({ html, meta, path: _path, resolve });
    });
  }

  export default function () {
    return async (mode, query, ...residuals) => {
      if (mode.enter || mode.update) {
        if (mode.enter) {
          layout.clear(":not([slot])");
          layout.append(page);
        }

        //console.log('residuals:', residuals)
        if (residuals.length) {
          const path = "/" + residuals.at(0);
          console.log("path:", path); ////
          let card = page.find(`[card="${path}"]`);
          //console.log("card:", card);////
          if (!card) {
            const promise = building.get(path);
            card = await promise;
          }

          const previous = page.find(`[page="${path}"]`);
          if (previous) {
            previous.classes.remove("hidden");
          }

          const post = card.detail.post;
          //console.log("post:", post);////
          items.classes.add("hidden");
          post.classes.remove("hidden");
          page.append(post);
          toTop(post);

          //items.replaceWith(post);
        } else {
          if (mode.update) {
            const previous = page.find(`[post]:not(.hidden)`);
            if (previous) {
              previous.classes.add("hidden");
            }

            items.classes.remove("hidden");
          }
        }
      } else {
        /* exit */
        page.remove();
      }
    };
  }
</script>
