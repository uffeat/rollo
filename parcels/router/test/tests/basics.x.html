<!--
/basics.x.html
-->
<style name="sheet">
  .nav-link {
    font-size: 1.25rem;
    cursor: pointer;
  }

  .nav-link.active {
    font-weight: 700;
  }
</style>

<script type="module">
  const { component } = await use("@/component.js");
  const { layout } = await use("@/layout/");
  const { router } = await use("@/router.js");

  export default async function () {
    this.sheet.use();
    layout.clear();

    router.effects.query.add(
      (change, message) => {
        //console.log("query:", change);
      },
      (change) => Object.keys(change).length
    );

    /* Define routes */
    router.routes.add({
      "/ding": await (async () => {
        const { component } = await use("@/component.js");
        const { layout } = await use("@/layout/");
        const { reactive, ref } = await use("@/state.js");

        const Page = (() => {
          let page;
          return () => {
            if (page) {
              return page;
            }
            page = component.main("container", component.h1({ text: "Ding" }));
            page.detail.queryOutput = component.output({
              parent: page,
              width: "100%",
            });
            page.detail.argsOutput = component.output({
              parent: page,
              width: "100%",
            });
            return page;
          };
        })();

        const states = {
          mode: ref(),
          query: reactive(),
          args: ref(),
        };

        /* Effect to control page display */
        states.mode.effects.add(
          (mode) => {
            const page = Page();
            console.log("mode:", mode);
            if (mode) {
              layout.clear(":not([slot])");
              layout.append(page);
            } else if (mode === false) {
              page.remove();
            }
          },
          { run: false }
        );

        /* Effect to control query display */
        states.query.effects.add(
          (query) => {
            const output = Page().detail.queryOutput;
            output.clear();
            console.log("query:", query);
            for (const [key, value] of Object.entries(query)) {
              output.append(
                component.p({ text: `Item: ${key}=${value}`, width: "100%" })
              );
            }
          },
          { run: false }
        );

        /* Effect to control args display */
        states.args.effects.add(
          (args) => {
            const output = Page().detail.argsOutput;
            output.clear();
            console.log("args:", args);
            for (const arg of args) {
              output.append(
                component.p({ text: `Arg: ${arg}`, width: "100%" })
              );
            }
          },
          { run: false }
        );

        return async (mode, query, ...args) => {
          states.mode(mode);
          states.query(query);
          states.args(args);
        };
      })(),
    });

    [
      ["/", "@@/test/pages/home.js"],
      ["/foo", "/test/pages/foo.js"],
      ["/color", "/test/pages/color.js"],
    ].forEach(([path, usePath]) => {
      router.routes.add({
        [path]: async (...args) => {
          const mod = await use(usePath);
          mod.default(...args);
        },
      });
    });
    /* Create nav */
    const nav = component.nav(
      "nav.d-flex.flex-column",
      { slot: "side", parent: layout },
      ...[
        ["Home", "/"],
        ["About", "/about?thing=42&baz&pink=pong"],
        ["Foo", "/foo"],
        ["Foo with args", "/foo/ding/dong"],
        ["About", "/about?thing=42&baz&pink=pong"],
        ["Ding", "/ding/dong?foo=42"],
        ["Color", "/color"],
        ["Color -> green", "/color/green"],
        ["Bad", "/bad"],
      ].map(([text, path]) => component.a("nav-link", { text, $path: path }))
    );

    nav.on.click = async (event) => {
      const target = event.target.closest(`[state-path]`);
      if (target) {
        event.preventDefault();
        router(target.$.path);
      }
      //layout.close();
    };

    router.effects.path.add(
      (current, message) => {
        let active = nav.find(`.active`);
        if (active) {
          active.classes.remove("active");
        }
        active = nav.find(`[state-path="${current}"]`);
        if (active) {
          active.classes.add("active");
        }
      },
      (current) => !!current
    );

    /* Handle initial
    NOTE Do after complete setup */
    await router.setup()
   
  }
</script>
